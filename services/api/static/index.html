<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bird Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        @media (prefers-color-scheme: dark) {
            body {
                background: #1a1a1a !important;
                color: #e0e0e0;
            }
            
            header {
                background: #2d2d2d !important;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            }
            
            header h1 {
                color: #ffffff !important;
            }
            
            h1 {
                color: #ffffff !important;
            }
            
            .stat-card {
                background: #2d2d2d !important;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            }
            
            .stat-label {
                color: #d0d0d0;
            }
            
            .stat-value {
                color: #85c1e9;
            }
            
            .filters {
                background: #2d2d2d !important;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            }
            
            .filters label {
                color: #e0e0e0;
            }
            
            .filters select, .filters button {
                background: #3d3d3d !important;
                color: #e0e0e0 !important;
                border-color: #555 !important;
            }
            
            .filters input[type="checkbox"] {
                accent-color: #3498db;
            }
            
            .filters button {
                background: #3498db !important;
                color: white !important;
            }
            
            .filters button:hover {
                background: #2980b9 !important;
            }
            
            .detection-card {
                background: #2d2d2d !important;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            }
            
            .detection-info {
                background: #2d2d2d !important;
            }
            
            .detection-info h3 {
                color: #ffffff !important;
            }
            
            .detection-info strong {
                color: #e0e0e0;
            }
            
            .live-view {
                background: #2d2d2d !important;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            }
            
            .live-view h2 {
                color: #ffffff !important;
            }
            
            .live-info {
                background: #3d3d3d !important;
            }
            
            .live-info p {
                color: #d0d0d0 !important;
            }
            
            .live-controls button {
                background: #3d3d3d !important;
                color: #e0e0e0 !important;
                border-color: #555 !important;
            }
            
            .live-controls button:hover {
                background: #4d4d4d !important;
            }
            
            .live-controls button.active {
                background: #3498db !important;
                color: white !important;
            }
            
            .pagination button {
                background: #3d3d3d !important;
                color: #e0e0e0 !important;
                border-color: #555 !important;
            }
            
            .pagination button:hover:not(:disabled) {
                background: #4d4d4d !important;
            }
            
            .loading {
                color: #b0b0b0;
            }
            
            .live-status {
                color: #b0b0b0 !important;
            }
            
            .detection-info p {
                color: #d0d0d0;
            }
            
            .detection-info p strong {
                color: #e8e8e8;
            }
            
            .weather-card {
                background: #2d2d2d !important;
            }
            
            .weather-card .stat-label {
                color: #d0d0d0;
            }
            
            .weather-card .stat-value {
                color: #85c1e9;
            }
            
            header p {
                color: #e8e8e8 !important;
            }
            
            .detection-info div[style*="border-top"] {
                border-top-color: #555 !important;
            }
            
            .detection-info div[style*="color: #555"] {
                color: #d0d0d0 !important;
            }
            
            .detection-info div[style*="color: #666"] {
                color: #c0c0c0 !important;
            }
            
            .detection-info div[style*="background: #f0f8ff"] {
                background: #2a3a4a !important;
                border-left-color: #85c1e9 !important;
            }
            
            .detection-info div[style*="color: #2c3e50"] {
                color: #f0f0f0 !important;
            }
            
            .detection-info div[style*="color: #555"][style*="font-style: italic"] {
                color: #d0d0d0 !important;
            }
            
            /* Override inline styles for better dark mode contrast */
            div[style*="color: #7f8c8d"] {
                color: #b0b0b0 !important;
            }
            
            .stat-card div[style*="color: #7f8c8d"] {
                color: #d0d0d0 !important;
            }
            
            .detection-info div[style*="color: #555"] p {
                color: #d0d0d0 !important;
            }
            
            .detection-info div[style*="color: #666"] {
                color: #c0c0c0 !important;
            }
            
            .detection-info div[style*="color: #666"] p {
                color: #c0c0c0 !important;
            }
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        .filters {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .filters label {
            margin-right: 15px;
        }
        
        .filters select, .filters button {
            padding: 8px 15px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .filters button {
            background: #3498db;
            color: white;
            border: none;
            cursor: pointer;
        }
        
        .filters button:hover {
            background: #2980b9;
        }
        
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .detection-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        
        .detection-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .detection-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .detection-card img:hover {
            opacity: 0.9;
        }
        
        .detection-info {
            padding: 15px;
        }
        
        .detection-info h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
            margin-right: 5px;
        }
        
        .badge.bird {
            background: #2ecc71;
            color: white;
        }
        
        .badge.motion {
            background: #95a5a6;
            color: white;
        }
        
        .badge.human {
            background: #e67e22;
            color: white;
        }
        
        .badge.both {
            background: #9b59b6;
            color: white;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .pagination button {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .pagination button:hover:not(:disabled) {
            background: #f5f5f5;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .live-view {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .live-view h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .live-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e74c3c;
            animation: pulse 2s infinite;
        }
        
        .live-indicator.active {
            background: #2ecc71;
        }
        
        .low-light-indicator {
            display: inline-block;
            margin-left: 15px;
            padding: 4px 12px;
            background: #34495e;
            color: #ecf0f1;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 500;
            opacity: 0.9;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 0.9; }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .live-image-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .live-image-container img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .live-image-container img:hover {
            opacity: 0.9;
        }
        
        .live-info {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .live-info p {
            margin: 5px 0;
            color: #555;
        }
        
        .live-controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .live-controls button {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .live-controls button:hover {
            background: #f5f5f5;
        }
        
        .live-controls button.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        /* Modal/Lightbox styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            cursor: pointer;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            max-width: 90vw;
            max-height: 90vh;
            width: 90vw;
            height: 90vh;
            object-fit: contain;
            cursor: default;
        }
        
        .modal-close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1001;
        }
        
        .modal-close:hover {
            color: #bbb;
        }
        
        .delete-button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            margin-top: 10px;
            width: 100%;
            transition: background 0.2s;
        }
        
        .delete-button:hover {
            background: #c0392b;
        }
        
        .delete-button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        
        .annotate-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: background 0.2s;
        }
        
        .annotate-button:hover {
            background: #2980b9;
        }
        
        .annotate-button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        
        /* Annotation modal styles */
        .annotation-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            align-items: center;
            justify-content: center;
        }
        
        .annotation-modal.active {
            display: flex;
        }
        
        .annotation-modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        @media (prefers-color-scheme: dark) {
            .annotation-modal-content {
                background: #2d2d2d;
                color: #f0f0f0;
            }
            
            .annotation-modal-content h2 {
                color: #ffffff;
            }
            
            .annotation-modal-content label {
                color: #f0f0f0;
            }
            
            .annotation-modal-content .form-group label {
                color: #f0f0f0;
            }
            
            .annotation-modal-content .radio-group label {
                color: #f0f0f0;
            }
            
            .annotation-modal-content input[type="text"],
            .annotation-modal-content textarea,
            .annotation-modal-content select {
                background: #3d3d3d;
                color: #f0f0f0;
                border-color: #555;
            }
            
            .annotation-modal-content input[type="text"]::placeholder,
            .annotation-modal-content textarea::placeholder {
                color: #b0b0b0;
                opacity: 1;
            }
            
            .annotation-modal-content input[type="radio"] {
                accent-color: #3498db;
            }
            
            .annotation-modal-content input[type="text"]:focus,
            .annotation-modal-content textarea:focus,
            .annotation-modal-content select:focus {
                border-color: #3498db;
                outline: none;
            }
        }
        
        .annotation-modal-content h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #2c3e50;
        }
        
        .annotation-modal-content .form-group {
            margin-bottom: 20px;
        }
        
        .annotation-modal-content label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        .annotation-modal-content input[type="text"],
        .annotation-modal-content textarea,
        .annotation-modal-content select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .annotation-modal-content textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .annotation-modal-content .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        
        .annotation-modal-content .radio-group label {
            display: flex;
            align-items: center;
            font-weight: normal;
            cursor: pointer;
        }
        
        .annotation-modal-content .radio-group input[type="radio"] {
            width: auto;
            margin-right: 8px;
        }
        
        .annotation-modal-content .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .annotation-modal-content button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .annotation-modal-content .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .annotation-modal-content .btn-primary:hover {
            background: #2980b9;
        }
        
        .annotation-modal-content .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .annotation-modal-content .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        .annotation-modal-content .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .annotation-modal-content .btn-danger:hover {
            background: #c0392b;
        }
        
        .annotation-modal-content .conditional-field {
            display: none;
        }
        
        .annotation-modal-content .conditional-field.show {
            display: block;
        }
        
        .bbox-toggle-btn {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(52, 152, 219, 0.9);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            z-index: 1002;
            transition: background 0.2s, transform 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .bbox-toggle-btn:hover {
            background: rgba(41, 128, 185, 1);
            transform: translateX(-50%) scale(1.05);
        }
        
        .bbox-toggle-btn.active {
            background: rgba(46, 204, 113, 0.9);
        }
        
        .bbox-toggle-btn.active:hover {
            background: rgba(39, 174, 96, 1);
        }
        
        /* Mobile responsive styles */
        @media (max-width: 768px) {
            * {
                -webkit-tap-highlight-color: transparent;
            }
            
            .container {
                padding: 10px;
            }
            
            header {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.5em;
            }
            
            button, select {
                min-height: 44px; /* Better touch target size */
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-value {
                font-size: 1.5em;
            }
            
            .stat-label {
                font-size: 0.8em;
            }
            
            .filters {
                padding: 15px;
                display: flex;
                flex-direction: column;
            }
            
            .filters label {
                display: block;
                margin-bottom: 10px;
                margin-right: 0;
            }
            
            .filters select, .filters button {
                width: 100%;
                margin-bottom: 10px;
                margin-right: 0;
            }
            
            .filters > div {
                flex-direction: column !important;
                width: 100% !important;
                margin-left: 0 !important;
                margin-top: 10px;
            }
            
            .filters > div label {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .filters > div button {
                width: 100%;
            }
            
            .gallery {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .detection-card img {
                height: 250px;
            }
            
            .live-view {
                padding: 15px;
            }
            
            .live-view h2 {
                font-size: 1.2em;
                flex-wrap: wrap;
            }
            
            .live-controls {
                flex-direction: column;
                gap: 8px;
            }
            
            .live-controls button {
                width: 100%;
            }
            
            .live-controls span {
                margin-left: 0 !important;
                margin-top: 5px;
                text-align: center;
                width: 100%;
            }
            
            .live-info {
                padding: 10px;
                font-size: 0.9em;
            }
            
            .pagination {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .pagination button {
                flex: 1;
                min-width: 80px;
            }
            
            .modal-close {
                top: 10px;
                right: 15px;
                font-size: 30px;
            }
            
            .detection-info {
                padding: 12px;
            }
            
            .detection-info h3 {
                font-size: 1em;
            }
            
            .detection-checkbox {
                width: 24px !important;
                height: 24px !important;
            }
        }
        
        @media (max-width: 480px) {
            .stats {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.3em;
            }
            
            .stat-value {
                font-size: 1.3em;
            }
            
            .low-light-indicator {
                font-size: 0.75em;
                padding: 3px 8px;
                margin-left: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üê¶üë§ Bird & Human Monitor</h1>
            <p>Real-time bird and human detection and monitoring</p>
        </header>
        
        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-value" id="birds-detected">-</div>
                <div class="stat-label">Birds Detected</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="humans-detected">-</div>
                <div class="stat-label">Humans Detected</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="recent-24h">-</div>
                <div class="stat-label">Last 24 Hours</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="recent-7d">-</div>
                <div class="stat-label">Last 7 Days</div>
            </div>
            <div class="stat-card" id="weather-card" style="display: none;">
                <div class="stat-value" id="weather-temp">-</div>
                <div class="stat-label" id="weather-desc">-</div>
                <div style="font-size: 0.8em; color: #7f8c8d; margin-top: 5px;">
                    <span id="weather-humidity">-</span> | <span id="weather-wind">-</span>
                </div>
            </div>
        </div>
        
        <div class="live-view">
            <h2>
                <span class="live-indicator" id="live-indicator"></span>
                Live View
                <span id="low-light-indicator" class="low-light-indicator" style="display: none;" title="Low light conditions detected">
                    üåô Low Light
                </span>
            </h2>
            <div class="live-image-container" id="live-image-container">
                <div class="loading">Loading live image...</div>
            </div>
            <div class="live-controls">
                <button id="toggle-live" onclick="toggleLiveView()">Auto-refresh: OFF</button>
                <button onclick="loadLiveImage()">Refresh Now</button>
                <button id="snapshot-btn" onclick="loadSnapshot()">Take Snapshot</button>
                <span id="live-status" style="margin-left: auto; color: #7f8c8d; font-size: 0.9em;"></span>
            </div>
        </div>
        
        <div class="filters">
            <label>
                Filter by Category:
                <select id="filter-category">
                    <option value="">All</option>
                    <option value="bird">Birds Only</option>
                    <option value="human">Humans Only</option>
                    <option value="both">Both Birds & Humans</option>
                </select>
            </label>
            <label>
                Filter by Time:
                <select id="filter-time">
                    <option value="">All Time</option>
                    <option value="24h">Last 24 Hours</option>
                    <option value="7d">Last 7 Days</option>
                    <option value="30d">Last 30 Days</option>
                    <option value="90d">Last 90 Days</option>
                </select>
            </label>
            <label style="display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" id="filter-hide-incorrect" checked onchange="loadDetections(1)">
                Hide incorrect detections
            </label>
            <button onclick="loadDetections()">Refresh</button>
            <div style="margin-left: auto; display: flex; align-items: center; gap: 10px;">
                <label style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="select-all" onchange="toggleSelectAll()">
                    Select All
                </label>
                <button id="bulk-delete-btn" onclick="bulkDeleteSelected()" style="background: #e74c3c; display: none;">
                    üóëÔ∏è Delete Selected (<span id="selected-count">0</span>)
                </button>
            </div>
        </div>
        
        <div id="error" class="error" style="display: none;"></div>
        
        <div id="gallery" class="gallery">
            <div class="loading">Loading detections...</div>
        </div>
        
        <div class="pagination" id="pagination"></div>
        
        <!-- Modal for enlarged images -->
        <div id="imageModal" class="modal" onclick="closeModal()">
            <span class="modal-close" onclick="closeModal(event)">&times;</span>
            <div style="position: relative; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%;">
                <img class="modal-content" id="modalImage" src="" alt="Enlarged detection image" onclick="event.stopPropagation()" style="display: none;">
                <video class="modal-content" id="modalVideo" controls onclick="event.stopPropagation()" style="display: none; max-width: 90vw; max-height: 90vh;">
                    Your browser does not support the video tag.
                </video>
                <button id="bboxToggleBtn" class="bbox-toggle-btn" onclick="toggleBboxView(event)" style="display: none;" title="Toggle bounding box view">
                    üì¶ Show BBox
                </button>
                <button id="videoToggleBtn" class="bbox-toggle-btn" onclick="toggleVideoView(event)" style="display: none; right: 60px;" title="Toggle video view">
                    üé• Show Video
                </button>
            </div>
        </div>
        
        <!-- Annotation Modal -->
        <div id="annotationModal" class="annotation-modal" onclick="closeAnnotationModal(event)">
            <div class="annotation-modal-content" onclick="event.stopPropagation()">
                <h2>Annotate Detection</h2>
                <form id="annotationForm" onsubmit="submitAnnotation(event)">
                    <input type="hidden" id="annotationDetectionId" value="">
                    
                    <div class="form-group">
                        <label>Is this detection correct?</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="is_correct" value="true" onchange="toggleAnnotationFields()">
                                Yes, correct
                            </label>
                            <label>
                                <input type="radio" name="is_correct" value="false" onchange="toggleAnnotationFields()">
                                No, incorrect
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group conditional-field" id="correctClassField">
                        <label for="correctClass">Correct Class:</label>
                        <select id="correctClass" name="correct_class">
                            <option value="">Select...</option>
                            <option value="bird">Bird</option>
                            <option value="squirrel">Squirrel</option>
                            <option value="human">Human</option>
                            <option value="none">None (false positive)</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group conditional-field" id="incorrectClassField">
                        <label for="incorrectClass">What was it incorrectly classified as? (auto-filled)</label>
                        <input type="text" id="incorrectClass" name="incorrect_class" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="annotationNotes">Notes (optional):</label>
                        <textarea id="annotationNotes" name="notes" placeholder="Add any additional notes about this detection..."></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="closeAnnotationModal()">Cancel</button>
                        <button type="button" class="btn-danger" id="deleteAnnotationBtn" onclick="deleteAnnotation()" style="display: none;">Delete Annotation</button>
                        <button type="submit" class="btn-primary">Save Annotation</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        let currentPage = 1;
        const pageSize = 20;
        let liveViewInterval = null;
        let liveViewEnabled = false; // Default to off - user must enable auto-refresh
        const LIVE_REFRESH_INTERVAL = 5000; // 5 seconds
        let captureStatusInterval = null;
        const CAPTURE_STATUS_INTERVAL = 30000; // 30 seconds - check capture status less frequently
        let selectedDetections = new Set();
        
        // Helper function to format timestamps consistently in browser's local timezone
        function formatTimestamp(timestamp) {
            // If timestamp is a string, parse it as UTC (API returns UTC timestamps)
            // If it's already a Date object, use it directly
            let date;
            if (typeof timestamp === 'string') {
                // Check if the string has timezone info
                // ISO 8601 format: YYYY-MM-DDTHH:mm:ss[.sss][Z|¬±HH:mm]
                const hasTimezone = timestamp.includes('Z') || 
                                   timestamp.includes('+') || 
                                   (timestamp.match(/-\d{2}:\d{2}$/) !== null);
                
                if (!hasTimezone) {
                    // Naive datetime string - append Z to treat as UTC
                    date = new Date(timestamp + 'Z');
                } else {
                    // Has timezone info, parse directly
                    date = new Date(timestamp);
                }
            } else if (timestamp instanceof Date) {
                date = timestamp;
            } else {
                // Fallback: try to parse as-is
                date = new Date(timestamp);
            }
            
            // Format in browser's local timezone
            return date.toLocaleString(undefined, {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }
        
        // Helper function to format time-only timestamps
        function formatTime(timestamp) {
            let date;
            if (typeof timestamp === 'string') {
                const hasTimezone = timestamp.includes('Z') || 
                                   timestamp.includes('+') || 
                                   (timestamp.match(/-\d{2}:\d{2}$/) !== null);
                
                if (!hasTimezone) {
                    date = new Date(timestamp + 'Z');
                } else {
                    date = new Date(timestamp);
                }
            } else if (timestamp instanceof Date) {
                date = timestamp;
            } else {
                date = new Date(timestamp);
            }
            
            return date.toLocaleTimeString(undefined, {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }
        
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                
                document.getElementById('birds-detected').textContent = stats.birds_detected;
                document.getElementById('humans-detected').textContent = stats.humans_detected;
                document.getElementById('recent-24h').textContent = stats.recent_activity_24h;
                document.getElementById('recent-7d').textContent = stats.recent_activity_7d;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        async function loadWeather() {
            try {
                const response = await fetch('/api/weather');
                const weather = await response.json();
                
                const weatherCard = document.getElementById('weather-card');
                if (weather.temperature !== null && weather.temperature !== undefined) {
                    document.getElementById('weather-temp').textContent = `${weather.temperature.toFixed(1)}¬∞F`;
                    document.getElementById('weather-desc').textContent = weather.weather_description || 'N/A';
                    
                    let humidityText = '';
                    if (weather.humidity !== null && weather.humidity !== undefined) {
                        humidityText = `Humidity: ${weather.humidity}%`;
                    }
                    
                    let windText = '';
                    if (weather.wind_speed !== null && weather.wind_speed !== undefined) {
                        windText = `Wind: ${weather.wind_speed.toFixed(1)} km/h`;
                    }
                    
                    const details = [humidityText, windText].filter(x => x).join(' | ');
                    const detailsContainer = document.getElementById('weather-humidity').parentElement;
                    if (details) {
                        detailsContainer.innerHTML = details;
                    } else {
                        detailsContainer.innerHTML = '';
                    }
                    
                    weatherCard.style.display = 'block';
                } else {
                    weatherCard.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading weather:', error);
                document.getElementById('weather-card').style.display = 'none';
            }
        }
        
        async function loadDetections(page = 1) {
            currentPage = page;
            const gallery = document.getElementById('gallery');
            const errorDiv = document.getElementById('error');
            errorDiv.style.display = 'none';
            
            gallery.innerHTML = '<div class="loading">Loading detections...</div>';
            
            try {
                const filterCategory = document.getElementById('filter-category').value;
                const filterTime = document.getElementById('filter-time').value;
                const params = new URLSearchParams({
                    page: page.toString(),
                    page_size: pageSize.toString()
                });
                
                if (filterCategory) {
                    params.append('category', filterCategory);
                }
                
                // Calculate date range based on time filter
                if (filterTime) {
                    const now = new Date();
                    let startDate = new Date();
                    
                    switch (filterTime) {
                        case '24h':
                            startDate.setHours(now.getHours() - 24);
                            break;
                        case '7d':
                            startDate.setDate(now.getDate() - 7);
                            break;
                        case '30d':
                            startDate.setDate(now.getDate() - 30);
                            break;
                        case '90d':
                            startDate.setDate(now.getDate() - 90);
                            break;
                    }
                    
                    // Format as ISO 8601 string
                    params.append('start_date', startDate.toISOString());
                }
                
                const response = await fetch(`/api/detections?${params}`);
                const data = await response.json();
                
                // Filter out incorrect detections if filter is enabled
                let filteredDetections = data.detections;
                const hideIncorrect = document.getElementById('filter-hide-incorrect').checked;
                if (hideIncorrect) {
                    filteredDetections = data.detections.filter(detection => {
                        // Show detection if it has no annotation, or if annotation is correct
                        return !detection.annotation || detection.annotation.is_correct;
                    });
                }
                
                if (filteredDetections.length === 0) {
                    gallery.innerHTML = '<div class="loading">No detections found</div>';
                } else {
                    gallery.innerHTML = filteredDetections.map(detection => {
                        // Determine badge class and label based on category
                        let badgeClass = 'motion';
                        let badgeLabel = 'üëÅÔ∏è Motion';
                        if (detection.category === 'bird') {
                            badgeClass = 'bird';
                            badgeLabel = 'üê¶ Bird';
                        } else if (detection.category === 'human') {
                            badgeClass = 'human';
                            badgeLabel = 'üë§ Human';
                        } else if (detection.category === 'both') {
                            badgeClass = 'both';
                            badgeLabel = 'üê¶üë§ Both';
                        }
                        
                        // Get counts from metadata if available
                        const numBirds = detection.metadata?.num_birds || 0;
                        const numHumans = detection.metadata?.num_humans || 0;
                        const numDetections = detection.metadata?.num_detections || detection.num_detections || 0;
                        
                        // Use thumbnail if available, fallback to full image
                        const thumbnailUrl = `/api/images/${detection.image_path}?size=thumb`;
                        const fullImageUrl = `/api/images/${detection.image_path}`;
                        const bboxImageUrl = detection.bbox_image_path ? `/api/images/${detection.bbox_image_path}` : null;
                        const videoUrl = detection.video_path ? `/api/videos/${detection.video_path}` : null;
                        
                        return `
                        <div class="detection-card">
                            <div style="position: relative;">
                                <input type="checkbox" class="detection-checkbox" value="${detection.id}" onchange="updateBulkDeleteButton()" style="position: absolute; top: 10px; left: 10px; z-index: 10; width: 20px; height: 20px; cursor: pointer;">
                                ${videoUrl ? `
                                    <div style="position: absolute; top: 10px; right: 10px; z-index: 10; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.8em; pointer-events: none;">
                                        üé• Video Available
                                    </div>
                                ` : ''}
                                <img src="${thumbnailUrl}" 
                                     alt="Detection ${detection.id}"
                                     onclick="openModal('${fullImageUrl}', ${bboxImageUrl ? `'${bboxImageUrl}'` : 'null'}, ${videoUrl ? `'${videoUrl}'` : 'null'})"
                                     onerror="this.onerror=null; this.src='${fullImageUrl}';"
                                     style="width: 100%; height: 200px; object-fit: cover; cursor: pointer; transition: opacity 0.2s;">
                            </div>
                            <div class="detection-info">
                                <h3>
                                    <span class="badge ${badgeClass}">
                                        ${badgeLabel}
                                    </span>
                                    ${detection.confidence ? `Confidence: ${(detection.confidence * 100).toFixed(1)}%` : ''}
                                </h3>
                                ${detection.bird_name && (!detection.annotation || detection.annotation.is_correct) ? `
                                    <div style="margin: 10px 0; padding: 10px; background: #f0f8ff; border-radius: 4px; border-left: 3px solid #3498db;">
                                        <p style="margin: 0; font-weight: bold; color: #2c3e50; font-size: 1.1em;">üê¶ ${detection.bird_name}</p>
                                        ${detection.bird_backstory ? `<p style="margin: 5px 0 0 0; color: #555; font-style: italic; font-size: 0.9em;">${detection.bird_backstory}</p>` : ''}
                                    </div>
                                ` : ''}
                                <p><strong>Time:</strong> ${formatTimestamp(detection.timestamp)}</p>
                                ${numDetections ? `<p><strong>Total Detections:</strong> ${numDetections}</p>` : ''}
                                ${numBirds > 0 ? `<p><strong>Birds:</strong> ${numBirds}</p>` : ''}
                                ${numHumans > 0 ? `<p><strong>Humans:</strong> ${numHumans}</p>` : ''}
                                ${detection.weather ? `
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                                        <p style="font-size: 0.9em; color: #555;"><strong>üå§Ô∏è Weather:</strong></p>
                                        <p style="font-size: 0.85em; color: #666;">
                                            ${detection.weather.temperature !== null && detection.weather.temperature !== undefined ? `${detection.weather.temperature.toFixed(1)}¬∞F` : 'N/A'} | 
                                            ${detection.weather.weather_description || 'N/A'}
                                        </p>
                                        ${detection.weather.humidity !== null && detection.weather.humidity !== undefined ? `<p style="font-size: 0.85em; color: #666;">Humidity: ${detection.weather.humidity}%</p>` : ''}
                                        ${detection.weather.wind_speed !== null && detection.weather.wind_speed !== undefined ? `<p style="font-size: 0.85em; color: #666;">Wind: ${detection.weather.wind_speed.toFixed(1)} km/h</p>` : ''}
                                    </div>
                                ` : ''}
                                ${detection.annotation ? `
                                    <div style="margin-top: 10px; padding: 10px; background: ${detection.annotation.is_correct ? '#d4edda' : '#f8d7da'}; border-radius: 4px; border-left: 3px solid ${detection.annotation.is_correct ? '#28a745' : '#dc3545'};">
                                        <p style="margin: 0; font-weight: bold; color: ${detection.annotation.is_correct ? '#155724' : '#721c24'};">
                                            ${detection.annotation.is_correct ? '‚úì Correct' : '‚úó Incorrect'}
                                        </p>
                                        ${detection.annotation.correct_class ? `<p style="margin: 5px 0 0 0; font-size: 0.9em; color: ${detection.annotation.is_correct ? '#155724' : '#721c24'};"><strong>Correct:</strong> ${detection.annotation.correct_class}</p>` : ''}
                                        ${detection.annotation.incorrect_class ? `<p style="margin: 5px 0 0 0; font-size: 0.9em; color: ${detection.annotation.is_correct ? '#155724' : '#721c24'};"><strong>Was:</strong> ${detection.annotation.incorrect_class}</p>` : ''}
                                        ${detection.annotation.notes ? `<p style="margin: 5px 0 0 0; font-size: 0.85em; color: ${detection.annotation.is_correct ? '#155724' : '#721c24'}; font-style: italic;">${detection.annotation.notes}</p>` : ''}
                                    </div>
                                ` : ''}
                                <div style="display: flex; gap: 10px; margin-top: 10px;">
                                    <button class="annotate-button" onclick="openAnnotationModal(${detection.id}, event)" style="flex: 1;">
                                        ${detection.annotation ? '‚úèÔ∏è Edit Annotation' : 'üìù Annotate'}
                                    </button>
                                    <button class="delete-button" onclick="deleteDetection(${detection.id}, event)" style="flex: 1;">
                                        üóëÔ∏è Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    }).join('');
                }
                
                // Update pagination (use filtered count for display, but keep original page info)
                // Note: Pagination is based on server-side data, but we filter client-side
                // So we show the filtered results but keep the original pagination info
                updatePagination(data.page, data.total_pages);
                
                // Reset selection when page changes
                selectedDetections.clear();
                updateBulkDeleteButton();
            } catch (error) {
                errorDiv.textContent = `Error loading detections: ${error.message}`;
                errorDiv.style.display = 'block';
                gallery.innerHTML = '';
            }
        }
        
        function updatePagination(currentPage, totalPages) {
            const pagination = document.getElementById('pagination');
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let html = '';
            html += `<button onclick="loadDetections(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>`;
            html += `<span>Page ${currentPage} of ${totalPages}</span>`;
            html += `<button onclick="loadDetections(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>`;
            pagination.innerHTML = html;
        }
        
        async function checkCaptureStatus() {
            const lowLightIndicator = document.getElementById('low-light-indicator');
            try {
                const statusResponse = await fetch('/api/capture-status');
                if (statusResponse.ok) {
                    const captureStatus = await statusResponse.json();
                    if (captureStatus.low_light) {
                        lowLightIndicator.style.display = 'inline-block';
                        lowLightIndicator.title = `Low light conditions (brightness: ${(captureStatus.brightness * 100).toFixed(1)}%)`;
                    } else {
                        lowLightIndicator.style.display = 'none';
                    }
                }
            } catch (statusError) {
                // If status check fails, just hide the indicator
                lowLightIndicator.style.display = 'none';
            }
        }
        
        async function loadLiveImage() {
            const container = document.getElementById('live-image-container');
            const status = document.getElementById('live-status');
            const indicator = document.getElementById('live-indicator');
            const lowLightIndicator = document.getElementById('low-light-indicator');
            
            try {
                // Request live frame - it returns the image directly
                const timestamp = new Date();
                const imageUrl = `/api/live?t=${Date.now()}`;
                
                // Note: Capture status is now checked separately at a lower frequency
                // to reduce HTTP requests
                
                const formattedTime = formatTime(timestamp);
                const formattedTimestamp = formatTimestamp(timestamp);
                container.innerHTML = `
                    <img src="${imageUrl}" 
                         alt="Live view"
                         onclick="openModal('${imageUrl}')"
                         onload="document.getElementById('live-indicator').classList.add('active'); document.getElementById('live-status').textContent = 'Last updated: ${formattedTime}';"
                         onerror="document.getElementById('live-image-container').innerHTML = '<div class=\\'loading\\'>Error loading live image. Camera may be unavailable.</div>'; document.getElementById('live-status').textContent = 'Error'; document.getElementById('live-indicator').classList.remove('active');">
                    <div class="live-info">
                        <p><strong>Live View:</strong> Real-time camera feed</p>
                        <p><strong>Updated:</strong> ${formattedTimestamp}</p>
                        <p><em>This is a live capture from the camera, not a saved detection</em></p>
                    </div>
                `;
                
                indicator.classList.add('active');
            } catch (error) {
                console.error('Error loading live image:', error);
                container.innerHTML = '<div class="loading">Error loading live image</div>';
                status.textContent = 'Error';
                indicator.classList.remove('active');
                lowLightIndicator.style.display = 'none';
            }
        }
        
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return `${seconds} seconds ago`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            const days = Math.floor(hours / 24);
            return `${days} day${days > 1 ? 's' : ''} ago`;
        }
        
        function toggleLiveView() {
            const button = document.getElementById('toggle-live');
            liveViewEnabled = !liveViewEnabled;
            
            if (liveViewEnabled) {
                button.textContent = 'Auto-refresh: ON';
                button.classList.add('active');
                startLiveView();
            } else {
                button.textContent = 'Auto-refresh: OFF';
                button.classList.remove('active');
                stopLiveView();
            }
        }
        
        function startLiveView() {
            if (liveViewInterval) {
                clearInterval(liveViewInterval);
            }
            if (captureStatusInterval) {
                clearInterval(captureStatusInterval);
            }
            loadLiveImage(); // Load immediately
            checkCaptureStatus(); // Check status immediately
            liveViewInterval = setInterval(loadLiveImage, LIVE_REFRESH_INTERVAL);
            // Check capture status less frequently to reduce HTTP requests
            captureStatusInterval = setInterval(checkCaptureStatus, CAPTURE_STATUS_INTERVAL);
        }
        
        function stopLiveView() {
            if (liveViewInterval) {
                clearInterval(liveViewInterval);
                liveViewInterval = null;
            }
            if (captureStatusInterval) {
                clearInterval(captureStatusInterval);
                captureStatusInterval = null;
            }
        }
        
        async function loadSnapshot() {
            const btn = document.getElementById('snapshot-btn');
            const liveStatus = document.getElementById('live-status');
            const original = btn.textContent;
            try {
                btn.disabled = true;
                btn.textContent = 'Capturing...';
                liveStatus.textContent = 'Capturing snapshot...';
                
                const url = `/api/capture-snapshot?t=${Date.now()}`; // FastAPI should map to capture service proxy or direct endpoint
                // Open in modal for high-res view
                const modal = document.getElementById('imageModal');
                const modalImg = document.getElementById('modalImage');
                modalImg.src = url;
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
                
                // When image loads, update status
                modalImg.onload = () => {
                    liveStatus.textContent = 'Snapshot captured';
                };
                modalImg.onerror = () => {
                    liveStatus.textContent = 'Snapshot failed';
                    alert('Failed to capture snapshot');
                };
            } catch (e) {
                console.error('Snapshot error:', e);
                alert('Snapshot failed: ' + e.message);
                liveStatus.textContent = 'Snapshot failed';
            } finally {
                btn.disabled = false;
                btn.textContent = original;
            }
        }
        
        // Add event listeners for filter changes
        const filterTime = document.getElementById('filter-time');
        if (filterTime) {
            filterTime.addEventListener('change', function() {
                loadDetections(1); // Reset to page 1 when filter changes
            });
        }
        
        const filterCategory = document.getElementById('filter-category');
        if (filterCategory) {
            filterCategory.addEventListener('change', function() {
                loadDetections(1); // Reset to page 1 when filter changes
            });
        }
        
        // Load data on page load
        loadStats();
        loadWeather();
        loadDetections();
        // Auto-refresh is disabled by default - user must enable it manually
        // Load live image once on page load, but don't start auto-refresh
        loadLiveImage();
        // Check capture status once on page load
        checkCaptureStatus();
        
        // Refresh stats every 2 minutes (reduced from 30 seconds to reduce HTTP requests)
        setInterval(loadStats, 120000);
        // Refresh weather every 15 minutes (reduced from 5 minutes to reduce HTTP requests)
        setInterval(loadWeather, 900000);
        
        // Modal state for bbox toggle
        let currentModalState = {
            originalUrl: null,
            bboxUrl: null,
            videoUrl: null,
            showingBbox: false,
            showingVideo: false
        };
        
        // Modal functions for image enlargement
        function openModal(imageSrc, bboxImageSrc = null, videoSrc = null) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const modalVideo = document.getElementById('modalVideo');
            const bboxToggleBtn = document.getElementById('bboxToggleBtn');
            const videoToggleBtn = document.getElementById('videoToggleBtn');
            
            // Store URLs
            currentModalState.originalUrl = imageSrc;
            currentModalState.bboxUrl = bboxImageSrc;
            currentModalState.videoUrl = videoSrc;
            currentModalState.showingBbox = false;
            currentModalState.showingVideo = false;
            
            // Show/hide toggle buttons
            if (bboxImageSrc) {
                bboxToggleBtn.style.display = 'block';
                bboxToggleBtn.textContent = 'üì¶ Show BBox';
                bboxToggleBtn.classList.remove('active');
            } else {
                bboxToggleBtn.style.display = 'none';
            }
            
            if (videoSrc) {
                videoToggleBtn.style.display = 'block';
                videoToggleBtn.textContent = 'üé• Show Video';
                videoToggleBtn.classList.remove('active');
            } else {
                videoToggleBtn.style.display = 'none';
            }
            
            // Set initial view (image by default)
            modalImg.src = imageSrc;
            modalImg.style.display = 'block';
            modalVideo.style.display = 'none';
            modalVideo.pause();
            modalVideo.src = '';
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }
        
        function toggleBboxView(event) {
            event.stopPropagation(); // Prevent modal from closing
            
            const modalImg = document.getElementById('modalImage');
            const modalVideo = document.getElementById('modalVideo');
            const toggleBtn = document.getElementById('bboxToggleBtn');
            
            if (!currentModalState.bboxUrl) {
                return; // No bbox image available
            }
            
            // If showing video, switch to image first
            if (currentModalState.showingVideo) {
                modalVideo.style.display = 'none';
                modalVideo.pause();
                modalVideo.src = '';
                modalImg.style.display = 'block';
                currentModalState.showingVideo = false;
            }
            
            if (currentModalState.showingBbox) {
                // Switch to original
                modalImg.src = currentModalState.originalUrl;
                toggleBtn.textContent = 'üì¶ Show BBox';
                toggleBtn.classList.remove('active');
                currentModalState.showingBbox = false;
            } else {
                // Switch to bbox
                modalImg.src = currentModalState.bboxUrl;
                toggleBtn.textContent = 'üñºÔ∏è Show Original';
                toggleBtn.classList.add('active');
                currentModalState.showingBbox = true;
            }
        }
        
        function toggleVideoView(event) {
            event.stopPropagation(); // Prevent modal from closing
            
            const modalImg = document.getElementById('modalImage');
            const modalVideo = document.getElementById('modalVideo');
            const toggleBtn = document.getElementById('videoToggleBtn');
            
            if (!currentModalState.videoUrl) {
                return; // No video available
            }
            
            if (currentModalState.showingVideo) {
                // Switch to image
                modalVideo.style.display = 'none';
                modalVideo.pause();
                modalVideo.src = '';
                modalImg.style.display = 'block';
                toggleBtn.textContent = 'üé• Show Video';
                toggleBtn.classList.remove('active');
                currentModalState.showingVideo = false;
            } else {
                // Switch to video
                modalImg.style.display = 'none';
                modalVideo.src = currentModalState.videoUrl;
                modalVideo.style.display = 'block';
                modalVideo.load(); // Reload video
                toggleBtn.textContent = 'üñºÔ∏è Show Image';
                toggleBtn.classList.add('active');
                currentModalState.showingVideo = true;
            }
        }
        
        function closeModal(event) {
            if (event) {
                event.stopPropagation(); // Prevent event bubbling
            }
            const modal = document.getElementById('imageModal');
            const modalVideo = document.getElementById('modalVideo');
            modal.classList.remove('active');
            // Stop video playback when closing modal
            if (modalVideo) {
                modalVideo.pause();
                modalVideo.src = '';
            }
            document.body.style.overflow = 'auto'; // Restore scrolling
        }
        
        // Close modal on Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });
        
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('select-all');
            const checkboxes = document.querySelectorAll('.detection-checkbox');
            const isChecked = selectAllCheckbox.checked;
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
                if (isChecked) {
                    selectedDetections.add(parseInt(checkbox.value));
                } else {
                    selectedDetections.delete(parseInt(checkbox.value));
                }
            });
            
            updateBulkDeleteButton();
        }
        
        function updateBulkDeleteButton() {
            const checkboxes = document.querySelectorAll('.detection-checkbox:checked');
            const selectedCount = checkboxes.length;
            const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
            const selectedCountSpan = document.getElementById('selected-count');
            const selectAllCheckbox = document.getElementById('select-all');
            
            // Update selected detections set
            selectedDetections.clear();
            checkboxes.forEach(checkbox => {
                selectedDetections.add(parseInt(checkbox.value));
            });
            
            // Update UI
            if (selectedCount > 0) {
                bulkDeleteBtn.style.display = 'inline-block';
                selectedCountSpan.textContent = selectedCount;
            } else {
                bulkDeleteBtn.style.display = 'none';
            }
            
            // Update select all checkbox state
            const allCheckboxes = document.querySelectorAll('.detection-checkbox');
            if (allCheckboxes.length > 0) {
                selectAllCheckbox.checked = selectedCount === allCheckboxes.length;
                selectAllCheckbox.indeterminate = selectedCount > 0 && selectedCount < allCheckboxes.length;
            }
        }
        
        async function bulkDeleteSelected() {
            const selectedIds = Array.from(selectedDetections);
            
            if (selectedIds.length === 0) {
                alert('No detections selected');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete ${selectedIds.length} detection(s)?`)) {
                return;
            }
            
            const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
            const originalText = bulkDeleteBtn.innerHTML;
            bulkDeleteBtn.disabled = true;
            bulkDeleteBtn.innerHTML = 'Deleting...';
            
            try {
                const response = await fetch('/api/detections/bulk', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ detection_ids: selectedIds })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`Successfully deleted ${result.deleted_count} detection(s)`);
                    selectedDetections.clear();
                    await loadDetections(currentPage);
                    await loadStats();
                } else {
                    const error = await response.json().catch(() => ({ detail: 'Unknown error' }));
                    alert(`Error deleting detections: ${error.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error bulk deleting detections:', error);
                alert(`Error deleting detections: ${error.message}`);
            } finally {
                bulkDeleteBtn.disabled = false;
                bulkDeleteBtn.innerHTML = originalText;
                updateBulkDeleteButton();
            }
        }
        
        async function deleteDetection(detectionId, event) {
            // Prevent event bubbling
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            // Confirm deletion
            if (!confirm(`Are you sure you want to delete detection #${detectionId}?`)) {
                return;
            }
            
            // Find the button and disable it
            const button = event ? (event.target.tagName === 'BUTTON' ? event.target : event.target.closest('button')) : null;
            const originalText = button ? button.textContent : '';
            if (button) {
                button.disabled = true;
                button.textContent = 'Deleting...';
            }
            
            try {
                const response = await fetch(`/api/detections/${detectionId}`, {
                    method: 'DELETE'
                });
                
                if (response.status === 204) {
                    // Success - reload detections and stats
                    selectedDetections.delete(detectionId);
                    await loadDetections(currentPage);
                    await loadStats();
                    updateBulkDeleteButton();
                } else if (response.status === 404) {
                    alert('Detection not found. It may have already been deleted.');
                    await loadDetections(currentPage);
                } else {
                    const error = await response.json().catch(() => ({ detail: 'Unknown error' }));
                    alert(`Error deleting detection: ${error.detail || 'Unknown error'}`);
                    if (button) {
                        button.disabled = false;
                        button.textContent = originalText;
                    }
                }
            } catch (error) {
                console.error('Error deleting detection:', error);
                alert(`Error deleting detection: ${error.message}`);
                if (button) {
                    button.disabled = false;
                    button.textContent = originalText;
                }
            }
        }
        
        // Annotation functions
        let currentAnnotationDetection = null;
        
        async function openAnnotationModal(detectionId, event) {
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            currentAnnotationDetection = detectionId;
            const modal = document.getElementById('annotationModal');
            const form = document.getElementById('annotationForm');
            const deleteBtn = document.getElementById('deleteAnnotationBtn');
            
            // Reset form
            form.reset();
            document.getElementById('annotationDetectionId').value = detectionId;
            
            // Load existing annotation if any
            try {
                const response = await fetch(`/api/detections/${detectionId}/annotation`);
                if (response.ok) {
                    const annotation = await response.json();
                    // Populate form with existing annotation
                    if (annotation.is_correct) {
                        document.querySelector('input[name="is_correct"][value="true"]').checked = true;
                    } else {
                        document.querySelector('input[name="is_correct"][value="false"]').checked = true;
                    }
                    if (annotation.correct_class) {
                        document.getElementById('correctClass').value = annotation.correct_class;
                    }
                    if (annotation.incorrect_class) {
                        document.getElementById('incorrectClass').value = annotation.incorrect_class;
                    }
                    if (annotation.notes) {
                        document.getElementById('annotationNotes').value = annotation.notes;
                    }
                    deleteBtn.style.display = 'inline-block';
                } else {
                    // No existing annotation
                    deleteBtn.style.display = 'none';
                }
            } catch (error) {
                // No existing annotation or error loading
                deleteBtn.style.display = 'none';
            }
            
            // Load detection to get current classification
            try {
                const detectionResponse = await fetch(`/api/detections/${detectionId}`);
                if (detectionResponse.ok) {
                    const detection = await detectionResponse.json();
                    // Auto-fill incorrect class if not already set
                    if (!document.getElementById('incorrectClass').value) {
                        if (detection.category) {
                            document.getElementById('incorrectClass').value = detection.category;
                        } else if (detection.is_bird) {
                            document.getElementById('incorrectClass').value = 'bird';
                        } else if (detection.is_squirrel) {
                            document.getElementById('incorrectClass').value = 'squirrel';
                        } else if (detection.is_human) {
                            document.getElementById('incorrectClass').value = 'human';
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading detection:', error);
            }
            
            toggleAnnotationFields();
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeAnnotationModal(event) {
            if (event) {
                event.stopPropagation();
            }
            const modal = document.getElementById('annotationModal');
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
            currentAnnotationDetection = null;
        }
        
        function toggleAnnotationFields() {
            const isCorrect = document.querySelector('input[name="is_correct"]:checked')?.value === 'true';
            const correctClassField = document.getElementById('correctClassField');
            const incorrectClassField = document.getElementById('incorrectClassField');
            
            if (isCorrect) {
                correctClassField.classList.remove('show');
                incorrectClassField.classList.remove('show');
            } else {
                correctClassField.classList.add('show');
                incorrectClassField.classList.add('show');
            }
        }
        
        async function submitAnnotation(event) {
            event.preventDefault();
            
            const detectionId = parseInt(document.getElementById('annotationDetectionId').value);
            const isCorrect = document.querySelector('input[name="is_correct"]:checked')?.value === 'true';
            const correctClass = document.getElementById('correctClass').value || null;
            const incorrectClass = document.getElementById('incorrectClass').value || null;
            const notes = document.getElementById('annotationNotes').value || null;
            
            // Validate
            if (!isCorrect && !correctClass) {
                alert('Please select the correct class for incorrect detections.');
                return;
            }
            
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';
            
            try {
                const response = await fetch(`/api/detections/${detectionId}/annotate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        is_correct: isCorrect,
                        correct_class: correctClass,
                        incorrect_class: incorrectClass,
                        notes: notes
                    })
                });
                
                if (response.ok) {
                    closeAnnotationModal();
                    await loadDetections(currentPage);
                } else {
                    const error = await response.json().catch(() => ({ detail: 'Unknown error' }));
                    alert(`Error saving annotation: ${error.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error saving annotation:', error);
                alert(`Error saving annotation: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }
        
        async function deleteAnnotation() {
            if (!currentAnnotationDetection) {
                return;
            }
            
            if (!confirm('Are you sure you want to delete this annotation?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/detections/${currentAnnotationDetection}/annotation`, {
                    method: 'DELETE'
                });
                
                if (response.status === 204) {
                    closeAnnotationModal();
                    await loadDetections(currentPage);
                } else {
                    const error = await response.json().catch(() => ({ detail: 'Unknown error' }));
                    alert(`Error deleting annotation: ${error.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error deleting annotation:', error);
                alert(`Error deleting annotation: ${error.message}`);
            }
        }
        
        // Close annotation modal on Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const annotationModal = document.getElementById('annotationModal');
                if (annotationModal.classList.contains('active')) {
                    closeAnnotationModal();
                }
            }
        });
    </script>
</body>
</html>

