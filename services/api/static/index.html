<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bird Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        @media (prefers-color-scheme: dark) {
            body {
                background: #1a1a1a;
                color: #e0e0e0;
            }
            
            header {
                background: #2d2d2d;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            }
            
            h1 {
                color: #f0f0f0;
            }
            
            .stat-card {
                background: #2d2d2d;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            }
            
            .stat-label {
                color: #b0b0b0;
            }
            
            .filters {
                background: #2d2d2d;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            }
            
            .filters select, .filters button {
                background: #3d3d3d;
                color: #e0e0e0;
                border-color: #555;
            }
            
            .filters button:hover {
                background: #4d4d4d;
            }
            
            .detection-card {
                background: #2d2d2d;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            }
            
            .detection-info h3 {
                color: #f0f0f0;
            }
            
            .live-view {
                background: #2d2d2d;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            }
            
            .live-view h2 {
                color: #f0f0f0;
            }
            
            .live-info {
                background: #3d3d3d;
            }
            
            .live-info p {
                color: #d0d0d0;
            }
            
            .live-controls button {
                background: #3d3d3d;
                color: #e0e0e0;
                border-color: #555;
            }
            
            .live-controls button:hover {
                background: #4d4d4d;
            }
            
            .pagination button {
                background: #3d3d3d;
                color: #e0e0e0;
                border-color: #555;
            }
            
            .pagination button:hover:not(:disabled) {
                background: #4d4d4d;
            }
            
            .loading {
                color: #b0b0b0;
            }
            
            .live-status {
                color: #b0b0b0 !important;
            }
            
            .detection-info p {
                color: #d0d0d0;
            }
            
            .weather-card {
                background: #2d2d2d;
            }
            
            .weather-card .stat-label {
                color: #b0b0b0;
            }
            
            .weather-card .stat-value {
                color: #3498db;
            }
            
            .detection-info div[style*="border-top"] {
                border-top-color: #555 !important;
            }
            
            .detection-info div[style*="color: #555"] {
                color: #d0d0d0 !important;
            }
            
            .detection-info div[style*="color: #666"] {
                color: #c0c0c0 !important;
            }
            
            .detection-info div[style*="background: #f0f8ff"] {
                background: #2a3a4a !important;
                border-left-color: #3498db !important;
            }
            
            .detection-info div[style*="color: #2c3e50"] {
                color: #f0f0f0 !important;
            }
            
            .detection-info div[style*="color: #555"][style*="font-style: italic"] {
                color: #d0d0d0 !important;
            }
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        .filters {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .filters label {
            margin-right: 15px;
        }
        
        .filters select, .filters button {
            padding: 8px 15px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .filters button {
            background: #3498db;
            color: white;
            border: none;
            cursor: pointer;
        }
        
        .filters button:hover {
            background: #2980b9;
        }
        
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .detection-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        
        .detection-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .detection-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .detection-card img:hover {
            opacity: 0.9;
        }
        
        .detection-info {
            padding: 15px;
        }
        
        .detection-info h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
            margin-right: 5px;
        }
        
        .badge.bird {
            background: #2ecc71;
            color: white;
        }
        
        .badge.motion {
            background: #95a5a6;
            color: white;
        }
        
        .badge.human {
            background: #e67e22;
            color: white;
        }
        
        .badge.both {
            background: #9b59b6;
            color: white;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .pagination button {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .pagination button:hover:not(:disabled) {
            background: #f5f5f5;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .live-view {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .live-view h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .live-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e74c3c;
            animation: pulse 2s infinite;
        }
        
        .live-indicator.active {
            background: #2ecc71;
        }
        
        .low-light-indicator {
            display: inline-block;
            margin-left: 15px;
            padding: 4px 12px;
            background: #34495e;
            color: #ecf0f1;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 500;
            opacity: 0.9;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 0.9; }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .live-image-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .live-image-container img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .live-info {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .live-info p {
            margin: 5px 0;
            color: #555;
        }
        
        .live-controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .live-controls button {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .live-controls button:hover {
            background: #f5f5f5;
        }
        
        .live-controls button.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        /* Modal/Lightbox styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            cursor: pointer;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            cursor: default;
        }
        
        .modal-close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1001;
        }
        
        .modal-close:hover {
            color: #bbb;
        }
        
        .delete-button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            margin-top: 10px;
            width: 100%;
            transition: background 0.2s;
        }
        
        .delete-button:hover {
            background: #c0392b;
        }
        
        .delete-button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üê¶üë§ Bird & Human Monitor</h1>
            <p>Real-time bird and human detection and monitoring</p>
        </header>
        
        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-value" id="birds-detected">-</div>
                <div class="stat-label">Birds Detected</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="humans-detected">-</div>
                <div class="stat-label">Humans Detected</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="recent-24h">-</div>
                <div class="stat-label">Last 24 Hours</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="recent-7d">-</div>
                <div class="stat-label">Last 7 Days</div>
            </div>
            <div class="stat-card" id="weather-card" style="display: none;">
                <div class="stat-value" id="weather-temp">-</div>
                <div class="stat-label" id="weather-desc">-</div>
                <div style="font-size: 0.8em; color: #7f8c8d; margin-top: 5px;">
                    <span id="weather-humidity">-</span> | <span id="weather-wind">-</span>
                </div>
            </div>
        </div>
        
        <div class="live-view">
            <h2>
                <span class="live-indicator" id="live-indicator"></span>
                Live View
                <span id="low-light-indicator" class="low-light-indicator" style="display: none;" title="Low light conditions detected">
                    üåô Low Light
                </span>
            </h2>
            <div class="live-image-container" id="live-image-container">
                <div class="loading">Loading live image...</div>
            </div>
            <div class="live-controls">
                <button id="toggle-live" onclick="toggleLiveView()">Auto-refresh: OFF</button>
                <button onclick="loadLiveImage()">Refresh Now</button>
                <span id="live-status" style="margin-left: auto; color: #7f8c8d; font-size: 0.9em;"></span>
            </div>
        </div>
        
        <div class="filters">
            <label>
                Filter by Category:
                <select id="filter-category">
                    <option value="">All</option>
                    <option value="bird">Birds Only</option>
                    <option value="human">Humans Only</option>
                    <option value="both">Both Birds & Humans</option>
                </select>
            </label>
            <label>
                Filter by Time:
                <select id="filter-time">
                    <option value="">All Time</option>
                    <option value="24h">Last 24 Hours</option>
                    <option value="7d">Last 7 Days</option>
                    <option value="30d">Last 30 Days</option>
                    <option value="90d">Last 90 Days</option>
                </select>
            </label>
            <button onclick="loadDetections()">Refresh</button>
        </div>
        
        <div id="error" class="error" style="display: none;"></div>
        
        <div id="gallery" class="gallery">
            <div class="loading">Loading detections...</div>
        </div>
        
        <div class="pagination" id="pagination"></div>
        
        <!-- Modal for enlarged images -->
        <div id="imageModal" class="modal" onclick="closeModal()">
            <span class="modal-close" onclick="closeModal(event)">&times;</span>
            <img class="modal-content" id="modalImage" src="" alt="Enlarged detection image" onclick="event.stopPropagation()">
        </div>
    </div>
    
    <script>
        let currentPage = 1;
        const pageSize = 20;
        let liveViewInterval = null;
        let liveViewEnabled = false; // Default to off, user can enable if desired
        const LIVE_REFRESH_INTERVAL = 5000; // 5 seconds
        
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                
                document.getElementById('birds-detected').textContent = stats.birds_detected;
                document.getElementById('humans-detected').textContent = stats.humans_detected;
                document.getElementById('recent-24h').textContent = stats.recent_activity_24h;
                document.getElementById('recent-7d').textContent = stats.recent_activity_7d;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        async function loadWeather() {
            try {
                const response = await fetch('/api/weather');
                const weather = await response.json();
                
                const weatherCard = document.getElementById('weather-card');
                if (weather.temperature !== null && weather.temperature !== undefined) {
                    document.getElementById('weather-temp').textContent = `${weather.temperature.toFixed(1)}¬∞F`;
                    document.getElementById('weather-desc').textContent = weather.weather_description || 'N/A';
                    
                    let humidityText = '';
                    if (weather.humidity !== null && weather.humidity !== undefined) {
                        humidityText = `Humidity: ${weather.humidity}%`;
                    }
                    
                    let windText = '';
                    if (weather.wind_speed !== null && weather.wind_speed !== undefined) {
                        windText = `Wind: ${weather.wind_speed.toFixed(1)} km/h`;
                    }
                    
                    const details = [humidityText, windText].filter(x => x).join(' | ');
                    const detailsContainer = document.getElementById('weather-humidity').parentElement;
                    if (details) {
                        detailsContainer.innerHTML = details;
                    } else {
                        detailsContainer.innerHTML = '';
                    }
                    
                    weatherCard.style.display = 'block';
                } else {
                    weatherCard.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading weather:', error);
                document.getElementById('weather-card').style.display = 'none';
            }
        }
        
        async function loadDetections(page = 1) {
            currentPage = page;
            const gallery = document.getElementById('gallery');
            const errorDiv = document.getElementById('error');
            errorDiv.style.display = 'none';
            
            gallery.innerHTML = '<div class="loading">Loading detections...</div>';
            
            try {
                const filterCategory = document.getElementById('filter-category').value;
                const filterTime = document.getElementById('filter-time').value;
                const params = new URLSearchParams({
                    page: page.toString(),
                    page_size: pageSize.toString()
                });
                
                if (filterCategory) {
                    params.append('category', filterCategory);
                }
                
                // Calculate date range based on time filter
                if (filterTime) {
                    const now = new Date();
                    let startDate = new Date();
                    
                    switch (filterTime) {
                        case '24h':
                            startDate.setHours(now.getHours() - 24);
                            break;
                        case '7d':
                            startDate.setDate(now.getDate() - 7);
                            break;
                        case '30d':
                            startDate.setDate(now.getDate() - 30);
                            break;
                        case '90d':
                            startDate.setDate(now.getDate() - 90);
                            break;
                    }
                    
                    // Format as ISO 8601 string
                    params.append('start_date', startDate.toISOString());
                }
                
                const response = await fetch(`/api/detections?${params}`);
                const data = await response.json();
                
                if (data.detections.length === 0) {
                    gallery.innerHTML = '<div class="loading">No detections found</div>';
                } else {
                    gallery.innerHTML = data.detections.map(detection => {
                        // Determine badge class and label based on category
                        let badgeClass = 'motion';
                        let badgeLabel = 'üëÅÔ∏è Motion';
                        if (detection.category === 'bird') {
                            badgeClass = 'bird';
                            badgeLabel = 'üê¶ Bird';
                        } else if (detection.category === 'human') {
                            badgeClass = 'human';
                            badgeLabel = 'üë§ Human';
                        } else if (detection.category === 'both') {
                            badgeClass = 'both';
                            badgeLabel = 'üê¶üë§ Both';
                        }
                        
                        // Get counts from metadata if available
                        const numBirds = detection.metadata?.num_birds || 0;
                        const numHumans = detection.metadata?.num_humans || 0;
                        const numDetections = detection.metadata?.num_detections || detection.num_detections || 0;
                        
                        return `
                        <div class="detection-card">
                            <img src="/api/images/${detection.image_path}" 
                                 alt="Detection ${detection.id}"
                                 onclick="openModal('/api/images/${detection.image_path}')"
                                 onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'300\' height=\'200\'%3E%3Crect fill=\'%23ddd\' width=\'300\' height=\'200\'/%3E%3Ctext fill=\'%23999\' font-family=\'sans-serif\' font-size=\'14\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\'%3EImage not found%3C/text%3E%3C/svg%3E'">
                            <div class="detection-info">
                                <h3>
                                    <span class="badge ${badgeClass}">
                                        ${badgeLabel}
                                    </span>
                                    ${detection.confidence ? `Confidence: ${(detection.confidence * 100).toFixed(1)}%` : ''}
                                </h3>
                                ${detection.bird_name ? `
                                    <div style="margin: 10px 0; padding: 10px; background: #f0f8ff; border-radius: 4px; border-left: 3px solid #3498db;">
                                        <p style="margin: 0; font-weight: bold; color: #2c3e50; font-size: 1.1em;">üê¶ ${detection.bird_name}</p>
                                        ${detection.bird_backstory ? `<p style="margin: 5px 0 0 0; color: #555; font-style: italic; font-size: 0.9em;">${detection.bird_backstory}</p>` : ''}
                                    </div>
                                ` : ''}
                                <p><strong>Time:</strong> ${new Date(detection.timestamp).toLocaleString()}</p>
                                ${numDetections ? `<p><strong>Total Detections:</strong> ${numDetections}</p>` : ''}
                                ${numBirds > 0 ? `<p><strong>Birds:</strong> ${numBirds}</p>` : ''}
                                ${numHumans > 0 ? `<p><strong>Humans:</strong> ${numHumans}</p>` : ''}
                                ${detection.weather ? `
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                                        <p style="font-size: 0.9em; color: #555;"><strong>üå§Ô∏è Weather:</strong></p>
                                        <p style="font-size: 0.85em; color: #666;">
                                            ${detection.weather.temperature !== null && detection.weather.temperature !== undefined ? `${detection.weather.temperature.toFixed(1)}¬∞F` : 'N/A'} | 
                                            ${detection.weather.weather_description || 'N/A'}
                                        </p>
                                        ${detection.weather.humidity !== null && detection.weather.humidity !== undefined ? `<p style="font-size: 0.85em; color: #666;">Humidity: ${detection.weather.humidity}%</p>` : ''}
                                        ${detection.weather.wind_speed !== null && detection.weather.wind_speed !== undefined ? `<p style="font-size: 0.85em; color: #666;">Wind: ${detection.weather.wind_speed.toFixed(1)} km/h</p>` : ''}
                                    </div>
                                ` : ''}
                                <button class="delete-button" onclick="deleteDetection(${detection.id}, event)">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>
                    `;
                    }).join('');
                }
                
                // Update pagination
                updatePagination(data.page, data.total_pages);
            } catch (error) {
                errorDiv.textContent = `Error loading detections: ${error.message}`;
                errorDiv.style.display = 'block';
                gallery.innerHTML = '';
            }
        }
        
        function updatePagination(currentPage, totalPages) {
            const pagination = document.getElementById('pagination');
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let html = '';
            html += `<button onclick="loadDetections(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>`;
            html += `<span>Page ${currentPage} of ${totalPages}</span>`;
            html += `<button onclick="loadDetections(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>`;
            pagination.innerHTML = html;
        }
        
        async function loadLiveImage() {
            const container = document.getElementById('live-image-container');
            const status = document.getElementById('live-status');
            const indicator = document.getElementById('live-indicator');
            const lowLightIndicator = document.getElementById('low-light-indicator');
            
            try {
                // Request live frame - it returns the image directly
                const timestamp = new Date();
                const imageUrl = `/api/live?t=${Date.now()}`;
                
                // Also check capture status for low light detection
                try {
                    const statusResponse = await fetch('/api/capture-status');
                    if (statusResponse.ok) {
                        const captureStatus = await statusResponse.json();
                        if (captureStatus.low_light) {
                            lowLightIndicator.style.display = 'inline-block';
                            lowLightIndicator.title = `Low light conditions (brightness: ${(captureStatus.brightness * 100).toFixed(1)}%)`;
                        } else {
                            lowLightIndicator.style.display = 'none';
                        }
                    }
                } catch (statusError) {
                    // If status check fails, just hide the indicator
                    lowLightIndicator.style.display = 'none';
                }
                
                container.innerHTML = `
                    <img src="${imageUrl}" 
                         alt="Live view"
                         onload="document.getElementById('live-indicator').classList.add('active'); document.getElementById('live-status').textContent = 'Last updated: ${new Date().toLocaleTimeString()}';"
                         onerror="document.getElementById('live-image-container').innerHTML = '<div class=\\'loading\\'>Error loading live image. Camera may be unavailable.</div>'; document.getElementById('live-status').textContent = 'Error'; document.getElementById('live-indicator').classList.remove('active');">
                    <div class="live-info">
                        <p><strong>Live View:</strong> Real-time camera feed</p>
                        <p><strong>Updated:</strong> ${timestamp.toLocaleString()}</p>
                        <p><em>This is a live capture from the camera, not a saved detection</em></p>
                    </div>
                `;
                
                indicator.classList.add('active');
            } catch (error) {
                console.error('Error loading live image:', error);
                container.innerHTML = '<div class="loading">Error loading live image</div>';
                status.textContent = 'Error';
                indicator.classList.remove('active');
                lowLightIndicator.style.display = 'none';
            }
        }
        
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return `${seconds} seconds ago`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            const days = Math.floor(hours / 24);
            return `${days} day${days > 1 ? 's' : ''} ago`;
        }
        
        function toggleLiveView() {
            const button = document.getElementById('toggle-live');
            liveViewEnabled = !liveViewEnabled;
            
            if (liveViewEnabled) {
                button.textContent = 'Auto-refresh: ON';
                button.classList.add('active');
                startLiveView();
            } else {
                button.textContent = 'Auto-refresh: OFF';
                button.classList.remove('active');
                stopLiveView();
            }
        }
        
        function startLiveView() {
            if (liveViewInterval) {
                clearInterval(liveViewInterval);
            }
            loadLiveImage(); // Load immediately
            liveViewInterval = setInterval(loadLiveImage, LIVE_REFRESH_INTERVAL);
        }
        
        function stopLiveView() {
            if (liveViewInterval) {
                clearInterval(liveViewInterval);
                liveViewInterval = null;
            }
        }
        
        // Add event listeners for filter changes
        const filterTime = document.getElementById('filter-time');
        if (filterTime) {
            filterTime.addEventListener('change', function() {
                loadDetections(1); // Reset to page 1 when filter changes
            });
        }
        
        const filterCategory = document.getElementById('filter-category');
        if (filterCategory) {
            filterCategory.addEventListener('change', function() {
                loadDetections(1); // Reset to page 1 when filter changes
            });
        }
        
        // Load data on page load
        loadStats();
        loadWeather();
        loadDetections();
        loadLiveImage(); // Load once on page load, but don't auto-refresh by default
        
        // Refresh stats every 30 seconds
        setInterval(loadStats, 30000);
        // Refresh weather every 5 minutes
        setInterval(loadWeather, 300000);
        
        // Modal functions for image enlargement
        function openModal(imageSrc) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.classList.add('active');
            modalImg.src = imageSrc;
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }
        
        function closeModal(event) {
            if (event) {
                event.stopPropagation(); // Prevent event bubbling
            }
            const modal = document.getElementById('imageModal');
            modal.classList.remove('active');
            document.body.style.overflow = 'auto'; // Restore scrolling
        }
        
        // Close modal on Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });
        
        async function deleteDetection(detectionId, event) {
            // Prevent event bubbling
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            // Confirm deletion
            if (!confirm(`Are you sure you want to delete detection #${detectionId}?`)) {
                return;
            }
            
            // Find the button and disable it
            const button = event ? (event.target.tagName === 'BUTTON' ? event.target : event.target.closest('button')) : null;
            const originalText = button ? button.textContent : '';
            if (button) {
                button.disabled = true;
                button.textContent = 'Deleting...';
            }
            
            try {
                const response = await fetch(`/api/detections/${detectionId}`, {
                    method: 'DELETE'
                });
                
                if (response.status === 204) {
                    // Success - reload detections and stats
                    await loadDetections(currentPage);
                    await loadStats();
                } else if (response.status === 404) {
                    alert('Detection not found. It may have already been deleted.');
                    await loadDetections(currentPage);
                } else {
                    const error = await response.json().catch(() => ({ detail: 'Unknown error' }));
                    alert(`Error deleting detection: ${error.detail || 'Unknown error'}`);
                    if (button) {
                        button.disabled = false;
                        button.textContent = originalText;
                    }
                }
            } catch (error) {
                console.error('Error deleting detection:', error);
                alert(`Error deleting detection: ${error.message}`);
                if (button) {
                    button.disabled = false;
                    button.textContent = originalText;
                }
            }
        }
    </script>
</body>
</html>

